@using System.Globalization
@model DepartmentViewModel

@{
    ViewBag.Title = "Afdelingsrooster";
    ViewBag.ContainerType = "container-fluid";
}

<div class="row">
    <div class="col-2">
        <h4>
            @Html.DisplayFor(model => model.Week)
            <span class="font-weight-normal">
                @Html.DisplayFor(model => model.Year)
            </span>
        </h4>
    </div>
    <div class="col">
        <h5>@ViewBag.Title @Html.DisplayFor(model => model.Department)</h5>
    </div>
    <div class="col-4 d-print-none text-right">
        <button class="btn btn-secondary" onclick="window.print()">Print</button>
        <button class="btn btn-secondary">Rooster kopiÃ«ren</button>
    </div>

</div>

<table class="table table-bordered table-striped table-sm">
    <thead class="text-center">
    <tr>
        <th class="text-left">@Html.DisplayNameFor(model => model.EmployeeShifts.FirstOrDefault().Name)</th>
        <th class="text-left">@Html.DisplayNameFor(model => model.EmployeeShifts.FirstOrDefault().Scale)</th>

        @foreach (var day in Model.DaysOfWeek)
        {
            <th>@ISOWeek.ToDateTime(Model.Year, Model.Week, day).ToString("ddd dd-MM")</th>
        }

        <th>Totaal</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var employeeShift in Model.EmployeeShifts)
    {
        <tr>
            <td>
                <span class="fa-stack fa-sm align-super">
                    @if (employeeShift.Shifts.Any(shift => shift.Notifications.Any()))
                    {
                        <i class="fa fa-stack-2x fa-square text-warning"></i>
                        <i class="fa fa-stack-1x fa-exclamation text-white"></i>
                    }
                </span>
                <span class="d-inline-block">
                    @Html.DisplayFor(model => employeeShift.Name)
                    <br/>
                    <span class="text-secondary">
                        @Html.DisplayFor(model => employeeShift.Contract)
                    </span>
                </span>
                <span class="align-super float-right">
                    <i class="fa fa-angle-down"></i>
                </span>
            </td>
            <td class="align-middle">@Html.DisplayFor(model => employeeShift.Scale)</td>

            @foreach (var day in Model.DaysOfWeek)
            {
                @if (employeeShift.Shifts.Any(shift => shift.Date.DayOfWeek == day))
                {
                    var shift = employeeShift.Shifts.First(shift1 => shift1.Date.DayOfWeek == day);

                    <td class="align-middle c-pointer" onclick="shiftModal(@($"{shift.Id}, {employeeShift.UserId}, '{employeeShift.Name}', '{Model.Department}', '{shift.Date:yyyy-MM-dd}', '{shift.StartTime:hh\\:mm}', '{shift.EndTime:hh\\:mm}'"))">
                        <span>
                            @if (shift.Notifications.Any())
                            {
                                <span class="fa-stack fa-sm"
                                      data-toggle="tooltip"
                                      data-placement="bottom"
                                      data-html="true"
                                      title="<ul class='list-unstyled'>@foreach (var notification in shift.Notifications) {<li>@notification</li>}</ul>">

                                    <i class="fa fa-stack-2x fa-square text-warning"></i>
                                    <i class="fa fa-stack-1x fa-briefcase text-white"></i>
                                </span>
                            }
                            else
                            {
                                <span class="fa-stack fa-sm">
                                    <i class="fa fa-stack-2x fa-square"></i>
                                    <i class="fa fa-stack-1x fa-briefcase text-white"></i>
                                </span>
                            }
                            @Html.DisplayFor(model => shift.StartTime)-@Html.DisplayFor(model => shift.EndTime)
                            @if (shift.BreakTime.Ticks > 0)
                            {
                                <br/>
                                <span>
                                    <span class="fa-stack fa-sm">
                                        <i class="fa fa-stack-2x fa-square"></i>
                                        <i class="fa fa-stack-1x fa-coffee text-white"></i>
                                    </span>
                                    @Html.DisplayFor(model => shift.BreakTime)
                                </span>
                            }
                        </span>
                    </td>
                }
                else
                {
                    <td class="c-pointer" onclick="shiftModal(@($"'', {employeeShift.UserId}, '{employeeShift.Name}', '{Model.Department}', '{ISOWeek.ToDateTime(Model.Year, Model.Week, day):yyyy-MM-dd}','',''"))">

                    </td>
                }
            }

            <td class="align-middle">
                <span class="@(employeeShift.PlannedTime > employeeShift.MaxHours ? "text-danger" : "")">
                    @($"{employeeShift.PlannedTime.TotalHours:00}:{employeeShift.PlannedTime.Minutes:00}")
                </span>
                <span> / </span>
                <span>
                    @($"{employeeShift.MaxHours.TotalHours:00}:{employeeShift.MaxHours.Minutes:00}")
                </span>
            </td>
        </tr>
    }
    </tbody>
</table>

<div class="modal fade" id="shiftEditModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form asp-action="SaveShift">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Dienst</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input asp-for="InputShift.ShiftId" hidden/>
                    <input asp-for="InputShift.UserId" hidden/>
                    
                    <input asp-for="Year" hidden/>
                    <input asp-for="Week" hidden/>

                    <div class="form-group">
                        <label asp-for="InputShift.UserName"></label>
                        <input asp-for="InputShift.UserName" class="form-control" readonly/>
                    </div>
                    <div class="form-group">
                        <label asp-for="InputShift.Date"></label>
                        <input asp-for="InputShift.Date" class="form-control" readonly/>
                    </div>
                    <div class="form-group">
                        <label asp-for="InputShift.Department"></label>
                        <input asp-for="InputShift.Department" class="form-control" readonly/>
                    </div>
                    <div class="form-group">
                        <label asp-for="InputShift.StartTime"></label>
                        <input asp-for="InputShift.StartTime" class="form-control"/>
                        <span asp-validation-for="InputShift.StartTime" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="InputShift.EndTime"></label>
                        <input asp-for="InputShift.EndTime" class="form-control"/>
                        <span asp-validation-for="InputShift.EndTime" class="text-danger"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Sluit</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial"/>

    <script>
        function shiftModal(shiftId, userId, userName, department, date, startTime, endTime) {
            $('#Input_ShiftId').val(shiftId)
            $('#Input_UserId').val(userId)
            $('#Input_UserName').val(userName)
            $('#Input_Department').val(department)
            $('#Input_Date').val(date)
            $('#Input_StartTime').val(startTime)
            $('#Input_EndTime').val(endTime)
            
            $('#shiftEditModal').modal('show');
        }
    </script>
}